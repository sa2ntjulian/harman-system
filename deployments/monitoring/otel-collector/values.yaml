mode: daemonset

image:
  repository: otel/opentelemetry-collector-contrib
  tag: "0.112.0"

presets:
  kubernetesAttributes:
    enabled: true
  kubeletMetrics:
    enabled: true
  logsCollection:
    enabled: true

config:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318
    filelog:
      include:
        - /var/log/pods/*/*/*.log
      exclude:
        - /var/log/pods/*/*/*_previous.log
      operators:
        - type: json_parser
          id: parser-json
          output: extract_metadata_from_filepath
          timestamp:
            parse_from: attributes.time
            layout: '%Y-%m-%dT%H:%M:%S.%fZ'
        - type: regex_parser
          id: extract_metadata_from_filepath
          regex: '^.*\/(?P<namespace>[^_]+)_(?P<pod_name>[^_]+)_(?P<uid>[^_]+)\/(?P<container_name>[^\.]+)\.log$'
          parse_from: attributes["log.file.path"]
        - type: move
          id: move_file_path
          from: attributes["log.file.path"]
          to: attributes["file_path"]
        - type: add
          id: add_source
          field: attributes["source"]
          value: "kubernetes"

  processors:
    memory_limiter:
      check_interval: 1s
      limit_mib: 512
    batch:
      timeout: 10s
      send_batch_size: 1024
    k8sattributes:
      auth_type: serviceAccount
      passthrough: false
      extract:
        metadata:
          - k8s.pod.name
          - k8s.pod.uid
          - k8s.node.name
          - k8s.namespace.name
          - k8s.deployment.name
          - k8s.daemonset.name
          - k8s.statefulset.name
          - k8s.job.name
          - k8s.cronjob.name
        labels:
          - tag_name: k8s.pod.label.app
            key: app
          - tag_name: k8s.pod.label.app_kubernetes_io/name
            key: app.kubernetes.io/name
        annotations:
          - tag_name: k8s.pod.annotation.prometheus.io/scrape
            key: prometheus.io/scrape
      pod_association:
        - sources:
            - from: resource_attribute
              name: k8s.pod.ip
        - sources:
            - from: resource_attribute
              name: k8s.pod.uid
        - sources:
            - from: connection

  exporters:
    prometheus:
      endpoint: "0.0.0.0:8889"
      const_labels:
        source: "opentelemetry-collector"
    otlp/tempo:
      endpoint: tempo.monitoring.svc.cluster.local:4317
      tls:
        insecure: true
    loki:
      endpoint: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
      default_labels_enabled:
        resource: true
        attributes: true
    debug:
      verbosity: normal

  service:
    pipelines:
      traces:
        receivers: [otlp]
        processors: [memory_limiter, k8sattributes, batch]
        exporters: [otlp/tempo, debug]
      metrics:
        receivers: [otlp, kubeletstats]
        processors: [memory_limiter, k8sattributes, batch]
        exporters: [prometheus, debug]
      logs:
        receivers: [otlp, filelog]
        processors: [memory_limiter, k8sattributes, batch]
        exporters: [loki, debug]
